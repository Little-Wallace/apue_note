## 进程环境



### 存储空间

* C程序的存储空间由以下五个部分组成
  * 正文段， 由CPU执行的机器指令，通常是只读的
  * 初始化数据段， 程序中包含的所有明确初始化的变量(函数中的变量在栈空间上)
  * 未初始化数据段，程序中没有初始值的变量，通常初始化为0或者空指针。
  * 栈，自动变量以及每次函数调用时所需保存的信息都保存在此部分。
  * 堆，用来进行动态存储分配

### 内存分配

* C采用malloc来分配内存，glibc的malloc实现中，包括mmap和brk两种策略。
  * 对于大小超过128K的内存申请，通过mmap从堆中分配一块连续的虚拟地址(4K对齐)， 当进程对其进行访问时，触发缺页中断，内核为其分配对应的物理页。
  * 对于大小不超过128K的内存申请，将堆顶的_edata往高地址推对应大小的位移，然后将该块虚拟地址的起始地址分配给进程， 如果该地址对应的物理页没有被访问过，那么进程第一次访问该地址时会触发缺页中断，然后内核为其分配物理页。
* C通过free来回收内存空间。
  * 对于通过brk分配出去内存，需要等到高地址内存释放后才能释放，这就产生了内存碎片。当最高地址空间的空闲内存超过128K时，执行内存紧缩操作(trim)
* tcmalloc与alloca
> tcmalloc通过线程-本地高速缓存（也就是c++11中的 thread_local），来为小对象分配内存，以减少从堆中分配内存带来的锁开销。
> alloca则是通过增加栈桢的长度，在当前函数的栈帧上分配空间，函数结束后内存自动释放。

